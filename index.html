<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Permissions-Policy" content="fullscreen=(self)">
  <title>Home</title>
  <style>
    /* ‚Äî‚Äî AUTH OVERLAY STYLES ‚Äî‚Äî */
    #auth-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 2000;
    }
    #auth-box {
      background: #1e2a1a;
      padding: 30px; border-radius: 12px;
      width: 320px; text-align: center;
      box-shadow: 0 0 15px rgba(0,0,0,0.8);
    }
    #auth-box h2 { color: #7cbf6a; margin-bottom: 20px; }
    #auth-box input {
      width: 100%; padding: 8px; margin: 8px 0;
      border: 1px solid #355e2a; background: #0d1a10; color: white;
      border-radius: 4px;
    }
    #auth-box button {
      width: 100%; padding: 10px; margin-top: 12px;
      border: none; border-radius: 6px; font-size: 16px;
      background: #4b8b3b; color: white; cursor: pointer;
    }
    #auth-box button:not(:last-child) { margin-bottom: 8px; }
    #auth-toggle, #auth-guest {
      background: none; border: none; color: #55C629;
      text-decoration: underline; margin-top: 10px; cursor: pointer;
    }
    #auth-error { color: #ff4444; min-height: 18px; margin-top: 8px; }
    /* ‚Äî‚Äî END AUTH OVERLAY ‚Äî‚Äî */
/* Page-load alert overlay */
/* Page-load alert overlay */
/* --------------------------------------------------
   OVERLAY & FADE
   -------------------------------------------------- */
/* Overlay full screen and centering */
#alertBox {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(20, 40, 10, 0.95);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;

  transition: opacity 0.76s ease;
  opacity: 1;
}

#alertBox.fade-out {
  opacity: 0;
}

/* Inner box with styles */
#alertBox .alert-content {
  background: linear-gradient(160deg, #2f4f1c, #5ca94b);
  box-shadow: 0 0 30px #a5e168;
  border-radius: 18px;
  padding: 28px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  color: #e3ffd0;
  font-family: Impact, sans-serif;
}
/* Text styling */
#alertBox .alert-content h2 {
  margin: 0 0 14px;
  color: #c6ff9b;
  font-size: 1.8em;
  font-weight: 700;
}

#alertBox .alert-content p {
  margin: 0 0 22px;
  color: #e0ffd0;
  line-height: 1.5;
  font-size: 1.05em;
}

/* Button styling */
#alertBox .alert-content button {
  background: linear-gradient(to bottom, #7cd34c, #4d8025);
  color: #f2ffe5;
  font-weight: 700;
  border: none;
  padding: 12px 26px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 1em;
  box-shadow: 0 4px 8px #a0ea6eaa;
  transition: transform 0.2s ease, background 0.3s ease;
}

#alertBox .alert-content button:hover {
  background: linear-gradient(to bottom, #8ae659, #538c2c);
  transform: scale(1.04);
}
    .alert-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }

    /* Make sure the alert overlay covers the whole screen and is centered */
#alert-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.7); /* semi-transparent black */
  display: none; /* start hidden */
  justify-content: center;
  align-items: center;
  z-index: 9999; /* super high to be on top */
}

/* The alert box itself */
#alert-box {
  background: white;
  padding: 20px 30px;
  border-radius: 8px;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

/* OK button styling */
#alert-ok-btn {
  margin-top: 20px;
  padding: 8px 15px;
  font-size: 16px;
  cursor: pointer;
}
    
    body, html {
      margin: 0;
      height: 100%;
      width: 100%;
      overflow-x: hidden;
      background: black;
      font-family: Impact, sans-serif;
      color: white;
      position: relative;
    }
    *, *::before, *::after { box-sizing: border-box; }

    #hyperbeam-container {
      width: 100%;
      height: calc(100vh - 50px);
      border: 4px solid;
      border-image: linear-gradient(to bottom, #555555, #0d0d0d) 1;
      background-color: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    #error-message {
      color: #ff4444; text-align: center; padding: 20px;
      display: none; font-weight: bold; font-size: 18px; margin-top: 10px;
    }

    #bottom-bar {
      position: absolute; bottom: 0; width: 100%; height: 50px;
      background: linear-gradient(to top,
        rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.2) 2%, #427B2C 98%);
      display: flex; align-items: center; padding: 0 20px;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.6);
      border-top-left-radius: 12px; border-top-right-radius: 12px;
    }
    #signout-btn {
  margin-left: auto;         /* push this button as far right as it can go */
  position: relative;        /* so you can layer it if needed */
  background: #b33;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  color: white;
  cursor: pointer;
  font-family: Impact, sans-serif;
  display: none;             /* hidden by default */
  z-index: 9999
}
    #timer { font-size: 30px; font-weight: bold; }
    #fullscreen-btn { background: none; border: none; margin-left: 20px; cursor: pointer; }
    #fullscreen-btn img { height: 40px; filter: invert(1); }

    /* Wrapper for fullscreen timer + toggle button */
    #fullscreen-timer-wrapper {
      position: fixed; top: 10px; right: 10px; z-index: 9999;
      background: rgba(0,0,0,0.7); padding: 6px 10px; border-radius: 8px;
      display: none; align-items: center; gap: 8px; font-size: 16px;
    }
    #fullscreen-timer { font-size: 30px; font-weight: bold; color: white; }
    #toggle-timer-btn {
      background: none; border: none; color: white;
      font-size: 24px; line-height: 1; cursor: pointer;
    }

    #copyright-text {
      margin-left: auto; margin-right: 20px;
      font-size: 14px; opacity: 0.85; user-select: none;
    }

    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: none; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .overlay.active { display: flex; }
   .overlay-content {
  width: 90vw;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 4vw;
  font-size: 2.5vw;
  background: #222;
  color: #fff;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.6);
}

/* For larger screens, scale font size back to normal */
@media (min-width: 600px) {
  .overlay-content {
    font-size: 14px;
    padding: 24px;
  }
}
    .overlay-content h2 { margin-top: 0; font-size: 32px; color: #7cbf6a; }
    .overlay-content p { margin: 15px 0; line-height: 1.5; }
    .overlay-content button {
      margin: 10px 5px 0; padding: 10px 20px; font-size: 18px;
      border: none; border-radius: 6px; cursor: pointer;
      font-family: Impact, sans-serif;
      background: linear-gradient(to bottom, #4b8b3b, #2f5822);
      color: white; transition: background 0.3s ease, transform 0.2s;
    }
    .overlay-content button:hover:not(:disabled) {
      background: linear-gradient(to bottom, #5ba44a, #376e2a);
      transform: scale(1.03);
    }
    .overlay-content button:disabled {
      background: #2a4f1d; cursor: not-allowed;
    }

   #server-switch {
  display: flex;
  flex-wrap: wrap; /* allow wrapping */
  gap: 10px;
  justify-content: center;
  margin: 20px 0;
  max-width: 600px; /* optional, keeps layout neat */
  margin-left: auto;
  margin-right: auto;
}

#server-switch button {
  flex: 0 0 calc(25% - 10px); /* 4 buttons per row */
  padding: 10px;
  font-family: Impact, sans-serif;
  background: linear-gradient(to bottom, #444, #222);
  color: white;
  border: 2px solid #555;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s, border-color 0.3s;
  box-sizing: border-box;
}

#server-switch button:not(.selected):hover {
  background: linear-gradient(to bottom, #555, #2b2b2b);
  border-color: #777;
}

#server-switch .selected {
  background: linear-gradient(to bottom, #6ea65a, #4b8b3b);
  border-color: #89c978;
  color: white;
  font-weight: bold;
}

    :fullscreen, :-webkit-full-screen { overflow: hidden !important; }
    :fullscreen #bottom-bar, :-webkit-full-screen #bottom-bar { display: none !important; }
    :fullscreen #hyperbeam-container,
    :-webkit-full-screen #hyperbeam-container {
      height: 100% !important; box-sizing: border-box;
    }
    .fullscreen-mode { height: 100vh !important; box-sizing: border-box; }
    /* 1) Target only the CVM image, set its height, and absorb all available space to its left */
#bottom-bar img[alt="CVM"] {
  height: 40px;
  margin-left: auto;    /* pushes the image (and everything after it) to the right edge */
  margin-right: 8px;    /* small gap between the image and the text */
}

/* 2) Reset the auto-margin on the copyright so it sits immediately after the logo */
#copyright-text {
  margin-left: 0;       /* cancel the existing ‚Äúpush-everything-left‚Äù rule */
  margin-right: 20px;   /* keep your existing right padding */
}

/* Base styles remain untouched */

/* Premium theme overrides */
    /* Unified Scrollbar Style for All Users */
/* Blended Regular + Premium Scrollbar */
::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}

::-webkit-scrollbar-track {
  background: #111; /* Dark regular base */
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #555 0%, #ffd700 50%, #55C629 100%);
  border-radius: 6px;
  border: 2px solid #222;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #777 0%, #ffe000 50%, #66e142 100%);
}
.premium-theme body, .premium-theme html {
  background: linear-gradient(135deg, #203520, #4CAF50) !important;
  color: #DFFFD6 !important;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif !important;
}

/* Auth overlay premium overrides */
.premium-theme #auth-overlay {
  background: rgba(30, 60, 10, 0.95) !important;
}

.premium-theme #auth-box {
  background: linear-gradient(145deg, #2a4b10, #4b8b3b) !important;
  box-shadow: 0 0 25px #88cc44 !important;
  border-radius: 16px !important;
}

.premium-theme #auth-box h2 {
  color: #a9e07b !important;
}

.premium-theme #auth-box input {
  background: #223822 !important;
  border: 1px solid #7cc24a !important;
  color: #d0f4b4 !important;
  border-radius: 8px !important;
  padding: 10px !important;
}

.premium-theme #auth-box button {
  background: linear-gradient(to bottom, #6abf3d, #3e7a15) !important;
  color: #eaf9d2 !important;
  font-weight: 700 !important;
  border-radius: 10px !important;
  cursor: pointer !important;
  box-shadow: 0 4px 6px #88cc44aa !important;
}

/* Bottom bar premium */
.premium-theme #bottom-bar {
  background: linear-gradient(90deg, #355e2a, #89c978) !important;
  box-shadow: 0 -4px 15px #8bcc42cc !important;
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
}

/* Buttons premium */
.premium-theme #signout-btn {
  background: #5a9c29 !important;
  box-shadow: 0 0 12px #a8e07c !important;
  font-weight: 600 !important;
  z-index: 9999
}

/* Overlay */
.premium-theme .overlay {
  background: rgba(20, 40, 10, 0.95) !important;
}

.premium-theme .overlay-content {
  background: linear-gradient(145deg, #295220, #4c9440) !important;
  border: 2px solid #79c050 !important;
  box-shadow: 0 0 20px #7dd041 !important;
}

.premium-theme .overlay-content h2 {
  color: #b9f786 !important;
}

.premium-theme .overlay-content button {
  background: linear-gradient(to bottom, #7cd34c, #4d8025) !important;
  box-shadow: 0 0 10px #a0ea6e !important;
}

/* Server switch buttons premium */
.premium-theme #server-switch button {
  background: linear-gradient(to bottom, #456e26, #2d4b13) !important;
  border-color: #6a9f33 !important;
}

.premium-theme #server-switch button:not(.selected):hover {
  background: linear-gradient(to bottom, #578f33, #3d6b1a) !important;
  border-color: #9cc95a !important;
}

.premium-theme #server-switch .selected {
  background: linear-gradient(to bottom, #91c849, #4d8025) !important;
  border-color: #ade874 !important;
  color: #f0ffe1 !important;
  font-weight: 700 !important;
}
  </style>
</head>
<body>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="V2: An immersive and secure Chromium VM running just on your browser, sign-up today!">

  <!-- ‚Äî‚Äî AUTH OVERLAY ‚Äî‚Äî -->
  <div id="overlay">
  <div id="auth-overlay">
    <div id="auth-box">
      <h2 id="auth-title">Login</h2>
      <input type="text" id="auth-username" placeholder="Username" autocomplete="username">
      <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
      <button id="auth-submit">Login</button>
      <button id="auth-guest"><b>Guest</b></button>
      <div id="auth-error"></div>
      <button id="auth-toggle">Don't have an account? Sign up</button>
      <i>Forgot password?</i>
      <i>E-mail <u>recover@cvm.rest</u> to get assistance</i>
    </div>
  </div>
    </div>
<body>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="Version 2.1: An immersive and secure Chromium VM sandbox running just on your browser!">

  <!-- Disable right-click -->
  <script>
    ['contextmenu','mousedown','mouseup'].forEach(evt =>
      document.addEventListener(evt, e => {
        if (evt==='contextmenu' || e.button===2) {
          e.preventDefault(); return false;
        }
      })
    );
  </script>

  <!-- Overlays -->

    <!-- PAGE-LOAD ALERT (visible immediately) -->
 <div id="alertBox">
  <div class="alert-content">
    <span style="font-size:48px;">ü´§</span>
    <h2>Announcement:</h2>
    <p>CVM development is currently paused, so there won't be any new updates, don't worry though, if anything breaks I WILL fix it!</p>
    <b></b>
    <p>I am aware that HB is <b>rate-limiting</b>, and there is nothing I can do about it, so if a server doesn't work, try a different one, but if <b>ALL</b> of the servers get rate-limited, you'll have to wait a day... But, I have added <b><u>3</u></b> more servers that are brand new. Very sorry for the inconvenience!</p>
    
    <button id="okButton">OK</button>
  </div>
</div>

  <div id="warning" class="overlay active">
    <div class="overlay-content">
      <h2>Thanks for using CVM!</h2>
      <p style="font-size:16px;">This app is in beta, and bugs may occur, if you found one, please email <b>broken-vm@craz.top</b></p>
      <i style="font-size:20px;">Why is there a time limit?</i>
      <p style="font-size:16.5px;">There is a time limit to keep things fair for other users, and to keep the servers up without crashing!</p>
      <i style="font-size:20px;">What is premium?</i>
      <p style="font-size:16.5px;">Premium accounts have longer session time (40 minutes), have a special theme, and are the first priority to fixing! It is only $1, if you are interested in purchasing, E-mail <b>premium@cvm.rest</b> (You are REQUIRED to have an account in order to purchase)</p>
      <p style="font-weight:bold;">
        <a href="https://cvm.rest/updates/" style="color:#55C629;text-decoration:underline;font-family:Impact, sans-serif;">
          Update logs
        </a>
      </p>
      <p style="font-weight:bold;">
        <a href="https://cvm.rest/dev/" style="color:#427B2C;text-decoration:underline;font-family:Impact, sans-serif;">
          I'm a developer for CVM
        </a>
      </p>
      <b>Select a server:</b>
      <div id="server-switch">
        <button data-url="https://hyperbeam.stilla-rrms-wlwv-k12-or-us.workers.dev/" class="selected">Main üî¥</button>
        <button data-url="https://hyperbeam-1.stilla-rrms-wlwv-k12-or-us.workers.dev/">1 üü¢</button>
        <button data-url="https://hyperbeam-2.stilla-rrms-wlwv-k12-or-us.workers.dev/">2 üî¥</button>
        <button data-url="https://hyperbeam-3.stilla-rrms-wlwv-k12-or-us.workers.dev/">3 üü¢</button>
        <button data-url="https://hyperbeam-4.stilla-rrms-wlwv-k12-or-us.workers.dev/">4 üü¢</button>
        <button data-url="https://hyperbeam-5.stilla-rrms-wlwv-k12-or-us.workers.dev/">5 üü¢</button>
        <button data-url="https://hyperbeam-6.stilla-rrms-wlwv-k12-or-us.workers.dev/">6 üü¢</button>
        <button data-url="https://hyperbeam-7.stilla-rrms-wlwv-k12-or-us.workers.dev/">7 üü¢</button>
        <button data-url="https://hyperbeam-8.stilla-rrms-wlwv-k12-or-us.workers.dev/">8 üü¢</button>
      </div>
      <p style="color:#ff4444;font-weight:bold;text-decoration:underline;">
        Warning: Keybinds on the VM will only work in fullscreen mode.
      </p>
      <p style="color:#FD0000;font-weight:bold;font-size:20px;">
        If every button is disabled, try refreshing the page. Also, if you leave this tab for more than five minutes, your session will end and your progress will be lost. This helps us free up VM space.
      </p>
      <label><input type="checkbox" id="acknowledge-checkbox"> I understand.</label><br>
      <button id="close-warning" disabled>Start session!</button><br>
      <i style="font-size:20px;margin-top:10px;display:block;">Version: 2.1</i>
    </div>
  </div>

  <div id="minute-warning" class="overlay">
    <div class="overlay-content">
      <p><span style="font-size:48px;">‚ö†Ô∏è</span> There is one minute left in your session.</p>
      <button id="minute-ok">OK</button>
    </div>
  </div>

  <div id="black-notif" class="overlay">
    <div class="overlay-content">
      <span style="font-size:48px;">ü§î</span>
      <p style="font-size:48px;">See only a black screen?</p>
      <button id="notif-yes">Yes, why?</button>
      <button id="notif-no">No, go away.</button>
    </div>
  </div>

  <div id="black-alert" class="overlay">
    <div class="overlay-content" style="display:flex;gap:15px;align-items:flex-start;">
      <div style="font-size:48px;line-height:1;">üíÄ</div>
      <div>
        <p style="font-size:24px;">If you just see a black screen for more than 5 seconds, it‚Äôs either:<br>
           1. HB was rate-limited<br>
           2. Too many users<br>
           3. The school blocked the frame<br>
           4. We're down temporarily</p>
        <p>Check back later or email <b>broken-vm@craz.top</b></p>
        <button id="black-ok">OK</button>
        <script>
  document.getElementById('black-ok').addEventListener('click', function () {
    window.location.href = 'https://cvm.rest';
  });
</script>
      </div>
    </div>
  </div>

  <!-- Hyperbeam VM & Errors -->
  <div id="hyperbeam-container"></div>
  <div id="error-message"></div>

  <!-- Bottom bar -->
 <div id="bottom-bar">
    <span id="timer">20:00</span>
    <button id="fullscreen-btn">
      <img src="https://cvm.rest/img/fullscreen.png" alt="FS" draggable="false">
    </button>

  <!-- Put signout *before* the auto-margin logo -->
  <button id="signout-btn">Sign Out</button>

  <!-- Your CVM logo ‚Äî now it will push *after* signout, not before -->
  <img src="https://cvm.rest/img/CVM.png" alt="CVM">

  <span id="copyright-text">2025 ¬© WZ LLC, VM by HB.</span>
</div>

  <!-- Fullscreen timer + toggle -->
  <div id="fullscreen-timer-wrapper">
    <div id="fullscreen-timer">20:00</div>
    <button id="toggle-timer-btn">&lt;</button>
  </div>

  <!-- Main script -->
<script type="module">
import Hyperbeam from "https://unpkg.com/@hyperbeam/web@latest/dist/index.js";

////////////////////////////////////////////////////////////////////////////////
// 1) YOUR PREMIUM CHECKER
function isUserPremium() {
  const token = localStorage.getItem("cvm_token");
  if (!token) return false;
  return localStorage.getItem("cvm_premium") === "1";
}

////////////////////////////////////////////////////////////////////////////////
// 2) EVERYTHING THAT USED TO LIVE IN DOMContentLoaded

function initApp() {
  // ======== apply premium theme ========
  // Premium theme toggle
// Premium theme toggle
// Premium theme toggle
if (isUserPremium()) {
  document.documentElement.classList.add("premium-theme");
} else {
  document.documentElement.classList.remove("premium-theme");
}

// ======== Replace content if user is premium ========
if (isUserPremium()) {
  // Change the <h2>
  const warningH2 = document.querySelector('#warning h2');
  if (warningH2) {
    warningH2.textContent = "Thanks for buying premium and using CVM!";
  }

  // Change the second paragraph inside #warning .overlay-content
  const paras = document.querySelectorAll('#warning .overlay-content p');
  if (paras[1]) {
    paras[1].textContent =
      "With premium, you got a special theme, 40 minutes of time, AND are the first priority to fixing, CVM is also updated frequently, so you will get early updates too!";
  }
  if (paras[2]) {
    paras[2].innerHTML = 
      `If you are enjoying premium, consider subscribing to my <a href="https://www.youtube.com/@wilburzenith" target="_blank" style="color:#55C629; text-decoration:underline;">YouTube</a> channel!`;
  }

  // Replace both <i> cases in one loop
  document.querySelectorAll('#warning .overlay-content i').forEach(elem => {
    const txt = elem.textContent.trim();
    if (txt === "What is premium?") {
      elem.textContent = " ";
    } else if (txt === "Why is there a time limit?") {
      elem.textContent = " ";
    }
  });

  // Replace #server-switch content
  const serverSwitch = document.getElementById('server-switch');
  if (serverSwitch) {
    serverSwitch.innerHTML = `
      <button data-url="https://hungry-hippo.stilla-rrms-wlwv-k12-or-us.workers.dev/" class="selected">Main üü¢</button>
      <button data-url="https://rubber-ducky.stilla-rrms-wlwv-k12-or-us.workers.dev/">1 üü¢</button>
    `;
  }

  // ======== Add personalized greeting below h2 ========
  const hour = new Date().getHours();
  const timeOfDay = hour < 12 ? "morning" : hour < 18 ? "afternoon" : "evening";
  const username = localStorage.getItem("cvm_username") || "User";
  const greetingText = `Good ${timeOfDay}, ${username}`;

  const h2 = document.querySelector("#warning .overlay-content > h2");
  if (h2) {
    const greeting = document.createElement("p");
    greeting.textContent = greetingText;
    greeting.style.fontSize = "30px";
    greeting.style.fontWeight = "bold";
    greeting.style.marginTop = "8px";
    h2.insertAdjacentElement("afterend", greeting);
  }
}

// Helper function to get current time of day string
function getTimeOfDay() {
  const hour = new Date().getHours();
  if (hour < 12) return "morning";
  if (hour < 18) return "afternoon";
  return "evening";
}

// Helper function to get username from localStorage (or fallback)
function getUsername() {
  return localStorage.getItem("cvm_username") || "User";
}

  // ======== grab our selected serverUrl ========
  let serverUrl = document.querySelector('#server-switch button.selected').dataset.url;

  // ======== server-switch listener ========
  document.querySelectorAll('#server-switch button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#server-switch button')
              .forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      serverUrl = btn.dataset.url;
    });
  });

  // ======== fullscreen toggle ========
  const fsWrapper = document.getElementById('fullscreen-timer-wrapper');
  const fsTimer   = document.getElementById('fullscreen-timer');
  const toggleBtn = document.getElementById('toggle-timer-btn');
  toggleBtn.addEventListener('click', () => {
    const hidden = fsTimer.style.display === 'none';
    fsTimer.style.display = hidden ? 'inline' : 'none';
    toggleBtn.textContent = hidden ? '<' : '>';
  });

  // ======== main start() ========
  async function start() {
    setTimeout(() => document.getElementById('black-notif').classList.add('active'), 5000);
    try {
      const res = await fetch(serverUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: "{}"
      });
      const { embed_url } = await res.json();
      await Hyperbeam(
        document.getElementById("hyperbeam-container"),
        embed_url,
        { iframeAttributes: { allow: "fullscreen" } }
      );
    } catch {
      const e = document.getElementById('error-message');
      e.style.display = 'block';
      e.textContent = "An unknown error occurred, try again later.";
    }
  }

  // ======== overlay & timer wiring ========
  let minuteAlertShown = false, timeoutExpired = false;
  document.getElementById('acknowledge-checkbox').addEventListener('change', e =>
    document.getElementById('close-warning').disabled = !e.target.checked
  );
  document.getElementById('close-warning').addEventListener('click', () => {
    document.getElementById('warning').classList.remove('active');
    start();
    startTimer();
  });
  document.getElementById('minute-ok').addEventListener('click', () =>
    document.getElementById('minute-warning').classList.remove('active')
  );
  document.getElementById('notif-no').addEventListener('click', () =>
    document.getElementById('black-notif').classList.remove('active')
  );
  document.getElementById('notif-yes').addEventListener('click', () => {
    document.getElementById('black-notif').classList.remove('active');
    document.getElementById('black-alert').classList.add('active');
  });
  document.getElementById('black-ok').addEventListener('click', () =>
    document.getElementById('black-alert').classList.remove('active')
  );
  document.getElementById('fullscreen-btn').addEventListener('click', async () => {
    if (!document.fullscreenElement) {
      await document.documentElement.requestFullscreen();
    } else {
      await document.exitFullscreen();
    }
  });
  document.addEventListener('fullscreenchange', () => {
    const inFS = !!document.fullscreenElement;
    document.getElementById('bottom-bar').style.display = inFS ? 'none' : 'flex';
    document.getElementById('hyperbeam-container')
            .classList.toggle('fullscreen-mode', inFS);
    fsWrapper.style.display = inFS ? 'flex' : 'none';
    if (inFS) { fsTimer.style.display = 'inline'; toggleBtn.textContent = '<'; }
  });

  // ======== timer ========
  function startTimer() {
    let t = isUserPremium() ? 40 * 60 : 20 * 60;
    updateTimerDisplay(t);
    const iv = setInterval(() => {
      if (t > 0) {
        t--;
        updateTimerDisplay(t);
        if (t === 60 && !minuteAlertShown) {
          minuteAlertShown = true;
          document.getElementById('minute-warning').classList.add('active');
        }
      } else {
        clearInterval(iv);
        timeoutExpired = true;
        window.removeEventListener('beforeunload', blockUnload);
        window.location.href = 'https://cvm.rest/';
      }
    }, 1000);
  }

  function updateTimerDisplay(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    const txt = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    document.getElementById('timer').textContent = txt;
    document.getElementById('fullscreen-timer').textContent = txt;
  }

  // ======== key blocking ========
  document.addEventListener('keydown', e => {
    if (e.ctrlKey) {
      if (!['c','v','C','V'].includes(e.key)) e.preventDefault();
    } else if (e.altKey||e.metaKey) {
      e.preventDefault();
    } else if (['F1','F5','Tab','Escape'].includes(e.key)) {
      e.preventDefault();
    }
  });
}

////////////////////////////////////////////////////////////////////////////////
// 3) HOOKING UP AUTH FLOW

document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("overlay");
  const guestBtn = document.getElementById("auth-guest");
  const submit   = document.getElementById("auth-submit");
  const toggle   = document.getElementById("auth-toggle");
  const titleEl  = document.getElementById("auth-title");
  const userEl   = document.getElementById("auth-username");
  const passEl   = document.getElementById("auth-password");
  const errorEl  = document.getElementById("auth-error");
  const WORKER_BASE = "https://cvm-accounts.stilla-rrms-wlwv-k12-or-us.workers.dev";

  let isSignup = false;
  let started  = false;

  function finishAuth() {
    overlay.style.display = "none";
    if (!started) {
      started = true;
      initApp();
    }
  }

  // Auto-login
  if (localStorage.getItem("cvm_token")) {
    finishAuth();
  }

  // Guest access
  guestBtn.addEventListener("click", finishAuth);

  // Toggle login/signup UI
  toggle.addEventListener("click", () => {
    isSignup = !isSignup;
    titleEl.textContent = isSignup ? "Sign Up" : "Login";
    submit.textContent   = isSignup ? "Sign Up" : "Login";
    toggle.textContent   = isSignup
      ? "Already have an account? Login"
      : "Don't have an account? Sign up";
    errorEl.textContent = "";
  });

  // Login / Sign Up flow
  submit.addEventListener("click", async () => {
    const username = userEl.value.trim();
    const password = passEl.value;
    if (!username || !password) {
      errorEl.textContent = "Please fill in both fields.";
      return;
    }
    const endpoint = isSignup ? "/signup" : "/login";
    try {
      const res = await fetch(WORKER_BASE + endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Unknown error");
localStorage.setItem("cvm_token", data.token);
localStorage.setItem("cvm_username", username);
localStorage.setItem("cvm_premium", data.premium ? "1" : "0");

if (isSignup) {
  finishAuth();
} else {
  finishAuth();
}
    } catch (err) {
      errorEl.textContent = err.message;
    }
  });
});
</script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById("overlay");

    const WORKER_BASE = "https://cvm-accounts.stilla-rrms-wlwv-k12-or-us.workers.dev";
    let isSignup = false;

    const titleEl = document.getElementById("auth-title");
    const userEl  = document.getElementById("auth-username");
    const passEl  = document.getElementById("auth-password");
    const submit  = document.getElementById("auth-submit");
    const toggle  = document.getElementById("auth-toggle");
    const guest   = document.getElementById("auth-guest");
    const errorEl = document.getElementById("auth-error");
    const signoutBtn = document.getElementById("signout-btn");

    function updateAuthUI() {
      const loggedIn = !!localStorage.getItem("cvm_token");
      if (signoutBtn) {
        signoutBtn.style.display = loggedIn ? "inline-block" : "none";
      }
    }

    toggle.addEventListener("click", () => {
      isSignup = !isSignup;
      titleEl.textContent  = isSignup ? "Sign Up" : "Login";
      submit.textContent   = isSignup ? "Sign Up" : "Login";
      toggle.textContent   = isSignup
        ? "Already have an account? Login"
        : "Don't have an account? Sign up";
      errorEl.textContent = "";
    });

  submit.addEventListener("click", async () => {
  const username = userEl.value.trim();
  const password = passEl.value;

  if (!username || !password) {
    errorEl.textContent = "Please fill in both fields.";
    return;
  }

  // Disable the button to prevent double-clicks
  submit.disabled = true;
  errorEl.textContent = ""; // clear previous errors

  const endpoint = isSignup ? "/signup" : "/login";

  try {
    const res = await fetch(WORKER_BASE + endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json();
    if (!res.ok) {
      // Check for unique constraint
      if (data.error?.includes("UNIQUE")) {
        throw new Error("That username is already taken. Please choose another.");
      }
      throw new Error(data.error || "Unknown error");
    }

    localStorage.setItem("cvm_token", data.token);
    localStorage.setItem("cvm_username", username);
    localStorage.setItem("cvm_premium", data.premium ? "1" : "0");

    updateAuthUI();
    overlay.style.display = "none";

    // For signups, reload the page
   if (isSignup) {
  window.removeEventListener('beforeunload', handleBeforeUnload);
  location.reload();
}

  } catch (err) {
    errorEl.textContent = err.message;
    submit.disabled = false; // re-enable on error
  }
});
    guest.addEventListener("click", () => {
      overlay.style.display = "none";
    });

    if (localStorage.getItem("cvm_token")) {
      overlay.style.display = "none";
    }

    if (signoutBtn) {
      signoutBtn.addEventListener("click", () => {
        localStorage.removeItem("cvm_token");
        localStorage.removeItem("cvm_username");
        updateAuthUI();
        overlay.style.display = "flex";
      });
    }

    updateAuthUI(); // Call it once after page load
  });

   okButton.addEventListener("click", () => {
  document.getElementById("alertBox").classList.add("fade-out");
  setTimeout(() => {
    document.getElementById("alertBox").style.display = "none";
  }, 760);
});

document.addEventListener("DOMContentLoaded", () => {
  // Function to check if user is premium
  function isUserPremium() {
    const token = localStorage.getItem("cvm_token");
    if (!token) {
      console.log("No token found in localStorage, user is not premium.");
      return false;
    }
    const isPremium = localStorage.getItem("cvm_premium") === "1";
    console.log(`Premium status: ${isPremium}`);
    return isPremium;
  }

  // Function to get time of day
  function getTimeOfDay() {
    const hour = new Date().getHours();
    if (hour < 12) return "morning";
    if (hour < 18) return "afternoon";
    return "evening";
  }

  // Function to get username
  function getUsername() {
    const username = localStorage.getItem("cvm_username") || "User";
    console.log(`Username retrieved: "${username}"`);
    return username;
  }

  // Select the overlay-content container
  const overlayContent = document.querySelector("#warning .overlay-content");
  if (!overlayContent) {
    console.log("No overlay-content found in #warning, cannot proceed.");
    return;
  }

  // Select the h2 element
  const h2 = overlayContent.querySelector("h2");
  if (!h2) {
    console.log("No h2 found in overlay-content, cannot add greeting.");
    return;
  }

  // Step 1: Add greeting for all logged-in users
  const username = getUsername();
  if (username !== "User") { // Only add for logged-in users
    // Check for existing greeting by ID
    const existingGreeting = document.querySelector("#user-greeting");
    if (!existingGreeting) {
      const timeOfDay = getTimeOfDay();
      const greetingText = `Good ${timeOfDay}, ${username}`;
      const greeting = document.createElement("p");
      greeting.id = "user-greeting";
      greeting.textContent = greetingText;
      greeting.style.fontSize = "30px";
      greeting.style.fontWeight = "bold";
      greeting.style.marginTop = "8px";
      h2.insertAdjacentElement("afterend", greeting);
      console.log(`Created greeting: "${greetingText}"`);
    } else {
      console.log(`Greeting already exists with ID user-greeting: "${existingGreeting.textContent}"`);
    }
  } else {
    console.log("No username in localStorage (guest user), skipping greeting creation.");
  }

  // Step 2: Remove duplicates for all users (delayed to catch late additions)
  setTimeout(() => {
    console.log("Checking for duplicate paragraphs in overlay-content.");
    const paragraphs = overlayContent.querySelectorAll("p");
    if (paragraphs.length === 0) {
      console.log("No <p> elements found in overlay-content, nothing to check.");
      return;
    }

    // Log all paragraphs before processing
    console.log("Paragraphs before duplicate removal:");
    paragraphs.forEach((p, index) => {
      console.log(`Index ${index}: "${p.textContent}" (ID: ${p.id || "none"})`);
    });

    const seenText = new Set();
    paragraphs.forEach((p, index) => {
      const text = p.textContent.trim().toLowerCase();
      if (seenText.has(text)) {
        console.log(`Removing duplicate paragraph at index ${index}: "${p.textContent}" (ID: ${p.id || "none"})`);
        p.remove();
      } else {
        seenText.add(text);
        console.log(`Keeping paragraph at index ${index}: "${p.textContent}" (ID: ${p.id || "none"})`);
      }
    });

    console.log(`Duplicate check complete. Total paragraphs after processing: ${overlayContent.querySelectorAll("p").length}`);
  }, 100); // Small delay to allow other DOM modifications
});

    let awayTimestamp = null;
const maxAwayTime = 5 * 60 * 1000; // 5 minutes in ms

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    // User left tab, start timing
    awayTimestamp = Date.now();
  } else if (document.visibilityState === 'visible') {
    // User came back, reset timer
    awayTimestamp = null;
  }
});

setInterval(() => {
  if (awayTimestamp) {
    if (Date.now() - awayTimestamp > maxAwayTime) {
      window.removeEventListener('beforeunload', handleBeforeUnload);
      location.reload();
    }
  }
}, 10000); // check every 10 seconds

   function handleBeforeUnload(e) {
  e.preventDefault();
  e.returnValue = '';
}

window.addEventListener('beforeunload', handleBeforeUnload);
</script>
</body>
</html>
